import { command, flag, flags } from "../../../zcli.ts";
import { asserts } from "../../../lib/asserts.ts";
import { dataTable } from "../../../lib/data-table.ts";
import { loading } from "../../../lib/loading.ts";
import * as psFlags from "../../../flags.ts";
import { pickJson } from "../../../lib/pick-json.ts";
import { config } from "../../../config.ts";
import { machines } from "../../../api/machines.ts";
import { defaultFields } from "../mod.ts";

/**
 * This variable is automatically generated by `zcli add`. Do not remove this
 * or change its name unless you're no longer using `zcli add`.
 */
const subCommands: ReturnType<typeof command>[] = [];

export const list = command("list", {
  short: "List machines.",
  long: ({ root }) => `
    List machines in your team.

    Pick a subset of fields to display:
    \`\`\`
    ${root.name} machine list -F name -F dtModified
    \`\`\`
  `,
  commands: subCommands,
  flags: psFlags.paginator.merge(flags({
    "agent-type": flag({
      aliases: ["a"],
      short: "Filter by agent type.",
    }).ostring(),
    "machine-type": flag({
      aliases: ["m"],
      short: "Filter by machine type.",
    }).ostring(),
    "name": flag({
      aliases: ["n"],
      short: "Filter by name.",
    }).ostring(),
    "region": flag({
      aliases: ["r"],
      short: "Filter by region.",
    }).ostring(),
  })),
  // We use command metadata in the `persistentPreRun` function to check if a
  // command requires an API key. If it does, we'll check to see if one is
  // set. If not, we'll throw an error.
  meta: {
    requireApiKey: true,
  },
}).run(
  async function* ({ flags }) {
    const team = await config.get("team");
    asserts(team, "You must be in a team to list machines.");
    const result = await loading(
      machines.list({
        limit: flags.limit,
        after: flags.after,
        orderBy: "dtCreated",
        order: flags.asc ? "asc" : undefined,
        agentType: flags["agent-type"],
        machineType: flags["machine-type"],
        region: flags.region,
        name: flags.name,
      }),
      { enabled: !flags.json },
    );

    asserts(result.ok, result);

    if (!flags.json) {
      for await (
        const line of dataTable(
          result.data.items,
          flags.fields ?? defaultFields,
        )
      ) {
        yield line;
      }
    } else {
      yield pickJson(result.data, flags.fields);
    }
  },
);
